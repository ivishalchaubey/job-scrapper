{% extends "dashboard/base.html" %}

{% block title %}Scrapers{% endblock %}
{% block page_title %}Scraper Control Panel{% endblock %}

{% block content %}
<style>
    input[type="range"].slider {
        -webkit-appearance: none;
        appearance: none;
        height: 6px;
        border-radius: 3px;
        outline: none;
        background: linear-gradient(to right, #4f46e5 0%, #4f46e5 var(--pct, 50%), #e5e7eb var(--pct, 50%), #e5e7eb 100%);
    }
    input[type="range"].slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px; height: 20px; border-radius: 50%;
        background: #4f46e5; cursor: pointer;
        border: 3px solid white;
        box-shadow: 0 1px 4px rgba(0,0,0,0.25);
    }
    input[type="range"].slider::-moz-range-thumb {
        width: 20px; height: 20px; border-radius: 50%;
        background: #4f46e5; cursor: pointer;
        border: 3px solid white;
        box-shadow: 0 1px 4px rgba(0,0,0,0.25);
    }
    input[type="range"].slider::-moz-range-track {
        height: 6px; border-radius: 3px; background: transparent;
    }
    .scroll-thin::-webkit-scrollbar { width: 5px; }
    .scroll-thin::-webkit-scrollbar-track { background: #f9fafb; }
    .scroll-thin::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
</style>

<div x-data="scraperPanel()" x-init="init()">

    <!-- Toasts -->
    <div class="fixed top-4 right-4 z-50 space-y-2">
        <template x-for="t in toasts" :key="t.id">
            <div x-show="t.show"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-x-8"
                 x-transition:enter-end="opacity-100 translate-x-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0 translate-x-8"
                 class="flex items-center gap-2 px-4 py-3 rounded-lg shadow-lg text-white text-sm font-medium min-w-[300px]"
                 :class="{'bg-green-600':t.type==='success','bg-red-600':t.type==='error','bg-blue-600':t.type==='info','bg-yellow-600':t.type==='warning'}">
                <span x-text="t.msg" class="flex-1"></span>
                <button @click="t.show=false" class="hover:opacity-75">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
        </template>
    </div>

    <!-- Results Modal -->
    <div x-show="showModal" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display:none"
         x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" @click="showModal=false"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col" @click.stop
             x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100">

            <!-- Header -->
            <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg flex items-center justify-center"
                         :class="modalTask?.status==='completed'?'bg-green-100':modalTask?.status==='cancelled'?'bg-yellow-100':'bg-red-100'">
                        <svg x-show="modalTask?.status==='completed'" class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                        <svg x-show="modalTask?.status==='cancelled'" class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01"/></svg>
                        <svg x-show="modalTask?.status==='failed'" class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">Scraping Results</h3>
                        <p class="text-xs text-gray-400" x-text="modalTask?.company_name || 'All Companies'"></p>
                    </div>
                </div>
                <button @click="showModal=false" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Stats -->
            <div class="px-6 py-3 bg-gray-50 border-b border-gray-100 grid grid-cols-4 gap-3">
                <div class="bg-white rounded-lg px-3 py-2 border border-gray-200 text-center">
                    <p class="text-[10px] text-gray-500 font-medium uppercase">Total</p>
                    <p class="text-lg font-bold text-gray-800" x-text="modalEntries.length"></p>
                </div>
                <div class="bg-white rounded-lg px-3 py-2 border border-green-200 text-center">
                    <p class="text-[10px] text-green-600 font-medium uppercase">Success</p>
                    <p class="text-lg font-bold text-green-600" x-text="modalEntries.filter(r=>r.ok).length"></p>
                </div>
                <div class="bg-white rounded-lg px-3 py-2 border border-red-200 text-center">
                    <p class="text-[10px] text-red-600 font-medium uppercase">Failed</p>
                    <p class="text-lg font-bold text-red-600" x-text="modalEntries.filter(r=>!r.ok).length"></p>
                </div>
                <div class="bg-white rounded-lg px-3 py-2 border border-indigo-200 text-center">
                    <p class="text-[10px] text-indigo-600 font-medium uppercase">Jobs</p>
                    <p class="text-lg font-bold text-indigo-600" x-text="modalEntries.reduce((s,r)=>s+(r.jobs||0),0).toLocaleString()"></p>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div class="px-6 py-2 border-b border-gray-100 flex items-center gap-2">
                <button @click="mFilter='all'" class="px-3 py-1 text-xs font-semibold rounded-full"
                        :class="mFilter==='all'?'bg-gray-800 text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        x-text="'All ('+modalEntries.length+')'"></button>
                <button @click="mFilter='ok'" class="px-3 py-1 text-xs font-semibold rounded-full"
                        :class="mFilter==='ok'?'bg-green-600 text-white':'bg-green-50 text-green-700 hover:bg-green-100'"
                        x-text="'Success ('+modalEntries.filter(r=>r.ok).length+')'"></button>
                <button @click="mFilter='fail'" class="px-3 py-1 text-xs font-semibold rounded-full"
                        :class="mFilter==='fail'?'bg-red-600 text-white':'bg-red-50 text-red-700 hover:bg-red-100'"
                        x-text="'Failed ('+modalEntries.filter(r=>!r.ok).length+')'"></button>
            </div>

            <!-- Results List -->
            <div class="flex-1 overflow-y-auto scroll-thin px-6 py-2">
                <template x-for="(e,i) in filteredModalEntries" :key="i">
                    <div class="flex items-center gap-3 py-2 border-b border-gray-50 last:border-0">
                        <div class="w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0"
                             :class="e.ok?'bg-green-100':'bg-red-100'">
                            <svg x-show="e.ok" class="w-3 h-3 text-green-600" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                            <svg x-show="!e.ok" class="w-3 h-3 text-red-600" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-800" x-text="e.company"></p>
                            <p x-show="e.ok" class="text-xs text-gray-500" x-text="e.jobs+' jobs'"></p>
                            <p x-show="!e.ok" class="text-xs text-red-500 truncate" x-text="e.error||'Error'"></p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <span x-show="e.ok" class="text-sm font-semibold text-green-600" x-text="e.jobs"></span>
                            <span x-show="!e.ok" class="text-xs text-red-400">--</span>
                            <p class="text-xs text-gray-400" x-text="e.dur+'s'"></p>
                        </div>
                    </div>
                </template>
                <div x-show="filteredModalEntries.length===0" class="text-center py-8 text-sm text-gray-400">No results</div>
            </div>

            <!-- Footer -->
            <div class="px-6 py-3 border-t border-gray-100 flex justify-end">
                <button @click="showModal=false" class="px-5 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Close</button>
            </div>
        </div>
    </div>

    <!-- Scraper Info Modal -->
    <div x-show="showInfoModal" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display:none"
         x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" @click="showInfoModal=false"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-md flex flex-col" @click.stop
             x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100">
            <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg bg-indigo-100 flex items-center justify-center">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900">Scraper Details</h3>
                </div>
                <button @click="showInfoModal=false" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="px-6 py-5">
                <div x-show="infoLoading" class="flex justify-center py-6">
                    <svg class="animate-spin h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                </div>
                <template x-if="scraperInfo && !infoLoading">
                    <div class="space-y-4">
                        <div>
                            <p class="text-xs text-gray-500 font-medium uppercase tracking-wide mb-1">Company</p>
                            <p class="text-sm font-semibold text-gray-800" x-text="scraperInfo.company"></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 font-medium uppercase tracking-wide mb-1">Scraper Class</p>
                            <p class="text-sm font-mono text-gray-700 bg-gray-50 px-3 py-1.5 rounded-lg" x-text="scraperInfo.scraper_class"></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 font-medium uppercase tracking-wide mb-1">Scraping URL</p>
                            <template x-if="scraperInfo.url">
                                <a :href="scraperInfo.url" target="_blank" rel="noopener noreferrer"
                                   class="text-sm text-indigo-600 hover:text-indigo-700 break-all underline decoration-indigo-300 hover:decoration-indigo-500"
                                   x-text="scraperInfo.url"></a>
                            </template>
                            <p x-show="!scraperInfo.url" class="text-sm text-gray-400 italic">Not available</p>
                        </div>
                        <div class="flex items-center gap-3 pt-2">
                            <span class="text-xs text-gray-500">Jobs in DB:</span>
                            <span class="text-sm font-semibold" :class="jobCount(scraperInfo.company)?'text-green-600':'text-gray-400'"
                                  x-text="jobCount(scraperInfo.company)?jobCount(scraperInfo.company).toLocaleString():'0'"></span>
                            <span class="text-xs text-gray-400 mx-1">|</span>
                            <span class="text-xs text-gray-500">Last scraped:</span>
                            <span class="text-sm text-gray-700" x-text="lastScraped(scraperInfo.company)"></span>
                        </div>
                    </div>
                </template>
            </div>
            <div class="px-6 py-3 border-t border-gray-100 flex justify-end gap-2">
                <button x-show="scraperInfo?.url" @click="window.open(scraperInfo.url,'_blank')"
                        class="px-4 py-2 text-sm font-semibold text-indigo-700 bg-indigo-50 rounded-lg hover:bg-indigo-100">
                    Open URL
                </button>
                <button @click="showInfoModal=false" class="px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Close</button>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex items-center justify-between mb-5">
            <div>
                <h2 class="text-lg font-semibold text-gray-800">Control Panel</h2>
                <p class="text-sm text-gray-500 mt-0.5">Configure and launch scraping tasks</p>
            </div>
            <span class="inline-flex items-center gap-1.5 text-sm text-gray-500">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                <span x-text="companies.length+' scrapers'"></span>
            </span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Workers Slider -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Parallel Workers <span class="text-xs text-gray-400 font-normal">(1-20)</span>
                </label>
                <div class="flex items-center gap-3">
                    <button @click="workers=Math.max(1,workers-1)"
                            class="w-8 h-8 flex items-center justify-center rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 text-sm font-bold">-</button>
                    <input type="range" x-model.number="workers" min="1" max="20" step="1"
                           class="flex-1 slider" :style="'--pct:'+((workers-1)/19*100)+'%'">
                    <button @click="workers=Math.min(20,workers+1)"
                            class="w-8 h-8 flex items-center justify-center rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 text-sm font-bold">+</button>
                    <span class="text-sm font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg min-w-[44px] text-center" x-text="workers"></span>
                </div>
                <p class="text-xs text-gray-400 mt-1">Only used for multi-company scraping</p>
            </div>

            <!-- Actions -->
            <div class="flex flex-col justify-end gap-2">
                <button @click="startAll()" :disabled="isRunning"
                        class="w-full inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-green-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span x-text="isRunning?'Running...':'Start All Scrapers'"></span>
                </button>
                <button @click="startSelected()" :disabled="selected.length===0||isRunning"
                        class="w-full inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-indigo-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                    <span x-text="selected.length?'Start Selected ('+selected.length+')':'Start Selected'"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Active Task -->
    <template x-if="task">
        <div class="rounded-xl shadow-sm border mb-6 overflow-hidden"
             :class="{'bg-blue-50 border-blue-200':isRunning,'bg-green-50 border-green-200':task.status==='completed','bg-red-50 border-red-200':task.status==='failed','bg-yellow-50 border-yellow-200':task.status==='cancelled'}">
            <div class="p-6">
                <!-- Header -->
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center"
                             :class="{'bg-blue-100':isRunning,'bg-green-100':task.status==='completed','bg-red-100':task.status==='failed','bg-yellow-100':task.status==='cancelled'}">
                            <svg x-show="isRunning" class="w-4 h-4 text-blue-600 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                            <svg x-show="task.status==='completed'" class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                            <svg x-show="task.status==='failed'" class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                            <svg x-show="task.status==='cancelled'" class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01"/></svg>
                        </div>
                        <div>
                            <h2 class="text-base font-semibold text-gray-800" x-text="task.company_name||'All Companies'"></h2>
                            <div class="flex items-center gap-2 mt-0.5">
                                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold"
                                      :class="{'bg-blue-100 text-blue-700':isRunning,'bg-green-100 text-green-700':task.status==='completed','bg-red-100 text-red-700':task.status==='failed','bg-yellow-100 text-yellow-700':task.status==='cancelled'}">
                                    <span class="w-1.5 h-1.5 rounded-full" :class="{'bg-blue-500 animate-pulse':isRunning,'bg-green-500':task.status==='completed','bg-red-500':task.status==='failed','bg-yellow-500':task.status==='cancelled'}"></span>
                                    <span x-text="task.status.charAt(0).toUpperCase()+task.status.slice(1)"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button x-show="!isRunning && liveEntries.length>0" @click="openModal(task)"
                                class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-white text-indigo-700 border border-indigo-200 text-xs font-semibold rounded-lg hover:bg-indigo-50">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            View Results
                        </button>
                        <button x-show="isRunning" @click="cancelTask(task.task_id)"
                                class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-600 text-white text-xs font-semibold rounded-lg hover:bg-red-700">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                            Cancel
                        </button>
                        <button x-show="!isRunning" @click="task=null;stopPoll()"
                                class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-white text-gray-600 border border-gray-200 text-xs font-semibold rounded-lg hover:bg-gray-50">
                            Dismiss
                        </button>
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 gap-3 mb-4" :class="isRunning?'sm:grid-cols-3':'sm:grid-cols-4'">
                    <div class="bg-white rounded-lg px-4 py-3 border border-gray-100 shadow-sm">
                        <p class="text-xs text-gray-500 font-medium uppercase tracking-wide">Progress</p>
                        <p class="text-xl font-bold text-gray-800" x-text="task.progress_percent+'%'"></p>
                    </div>
                    <div class="bg-white rounded-lg px-4 py-3 border border-gray-100 shadow-sm">
                        <p class="text-xs text-gray-500 font-medium uppercase tracking-wide">Companies</p>
                        <p class="text-xl font-bold text-gray-800" x-text="task.completed_companies+' / '+task.total_companies"></p>
                    </div>
                    <div class="bg-white rounded-lg px-4 py-3 border border-gray-100 shadow-sm">
                        <p class="text-xs text-gray-500 font-medium uppercase tracking-wide">Jobs Found</p>
                        <p class="text-xl font-bold text-green-600" x-text="task.total_jobs_found.toLocaleString()"></p>
                    </div>
                    <div x-show="!isRunning" class="bg-white rounded-lg px-4 py-3 border border-gray-100 shadow-sm">
                        <p class="text-xs text-gray-500 font-medium uppercase tracking-wide">Duration</p>
                        <p class="text-xl font-bold text-gray-800" x-text="fmtDur(task)"></p>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="w-full bg-white/60 rounded-full h-2.5 overflow-hidden mb-4">
                    <div class="h-full rounded-full transition-all duration-700"
                         :class="{'bg-blue-500':isRunning,'bg-green-500':task.status==='completed','bg-red-500':task.status==='failed','bg-yellow-500':task.status==='cancelled'}"
                         :style="'width:'+task.progress_percent+'%'"></div>
                </div>

                <!-- Live Results -->
                <div class="bg-white rounded-lg border border-gray-100 shadow-sm overflow-hidden">
                    <div class="px-4 py-2 bg-gray-50 border-b border-gray-100 flex items-center justify-between">
                        <h3 class="text-sm font-semibold text-gray-700">Live Results</h3>
                        <div class="flex items-center gap-3 text-xs">
                            <span x-show="liveEntries.filter(e=>e.ok).length" class="text-green-600" x-text="liveEntries.filter(e=>e.ok).length+' passed'"></span>
                            <span x-show="liveEntries.filter(e=>!e.ok).length" class="text-red-500" x-text="liveEntries.filter(e=>!e.ok).length+' failed'"></span>
                            <span class="text-gray-400" x-text="liveEntries.length+'/'+task.total_companies"></span>
                        </div>
                    </div>
                    <div x-ref="stream" class="max-h-48 overflow-y-auto scroll-thin p-2 font-mono text-xs">
                        <template x-if="liveEntries.length===0">
                            <div class="flex items-center justify-center gap-2 py-6 text-gray-400">
                                <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                </svg>
                                <span>Waiting for results...</span>
                            </div>
                        </template>
                        <template x-for="(e,i) in liveEntries" :key="i">
                            <div class="flex items-center gap-2 py-1 px-2 rounded" :class="e.ok?'hover:bg-green-50':'hover:bg-red-50'">
                                <span class="w-4 h-4 rounded-full flex items-center justify-center flex-shrink-0" :class="e.ok?'bg-green-100':'bg-red-100'">
                                    <svg x-show="e.ok" class="w-2.5 h-2.5 text-green-600" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                                    <svg x-show="!e.ok" class="w-2.5 h-2.5 text-red-600" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                                </span>
                                <span class="font-semibold min-w-[130px] text-gray-800" x-text="e.company"></span>
                                <span x-show="e.ok" class="text-green-600" x-text="e.jobs+' jobs'"></span>
                                <span x-show="!e.ok" class="text-red-500 truncate max-w-[200px]" x-text="e.error"></span>
                                <span class="ml-auto text-gray-400" x-text="e.dur+'s'"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Companies -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-5">
            <div>
                <h2 class="text-lg font-semibold text-gray-800">Companies</h2>
                <p class="text-sm text-gray-500 mt-0.5" x-text="filtered.length+' of '+companies.length"></p>
            </div>
            <div class="flex items-center gap-3 w-full sm:w-auto">
                <div class="relative flex-1 sm:flex-none">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    <input type="text" x-model="search" placeholder="Search companies..."
                           class="w-full sm:w-64 pl-10 pr-8 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <button x-show="search" @click="search=''" class="absolute right-2.5 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="relative" x-data="{open:false}">
                    <button @click="open=!open" class="inline-flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"/></svg>
                        <span x-text="sortLabels[sortBy]" class="hidden sm:inline"></span>
                    </button>
                    <div x-show="open" @click.away="open=false" x-transition
                         class="absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-10 py-1">
                        <template x-for="[key,label] in Object.entries(sortLabels)" :key="key">
                            <button @click="sortBy=key;open=false" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-50"
                                    :class="sortBy===key?'text-indigo-600 font-semibold':'text-gray-700'" x-text="label"></button>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Select bar -->
        <div class="flex items-center gap-4 mb-4 pb-4 border-b border-gray-100">
            <label class="inline-flex items-center gap-2 cursor-pointer text-sm text-gray-600 hover:text-gray-800">
                <input type="checkbox" :checked="allSelected" @change="toggleAll()"
                       class="w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <span x-text="allSelected?'Deselect All':'Select All ('+filtered.length+')'"></span>
            </label>
            <span x-show="selected.length" class="text-xs text-indigo-600 font-medium bg-indigo-50 px-2 py-1 rounded-full" x-text="selected.length+' selected'"></span>
            <button x-show="selected.length" @click="selected=[]" class="text-xs text-gray-500 hover:text-red-600">Clear</button>
        </div>

        <!-- Loading -->
        <div x-show="loading" class="flex justify-center py-12">
            <svg class="animate-spin h-8 w-8 text-indigo-500" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
        </div>

        <!-- Table -->
        <div x-show="!loading" class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                        <th class="pb-3 pr-3 w-10"></th>
                        <th class="pb-3 pr-3">Company</th>
                        <th class="pb-3 pr-3 text-right w-24">Jobs</th>
                        <th class="pb-3 pr-3 text-right w-36">Last Scraped</th>
                        <th class="pb-3 text-right w-32">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50">
                    <template x-for="c in paginated" :key="c">
                        <tr class="hover:bg-gray-50 transition-colors group">
                            <td class="py-2.5 pr-3">
                                <input type="checkbox" :checked="selected.includes(c)" @change="toggleOne(c)"
                                       class="w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            </td>
                            <td class="py-2.5 pr-3">
                                <span class="text-sm font-medium text-gray-800" x-text="c"></span>
                            </td>
                            <td class="py-2.5 pr-3 text-right">
                                <span class="text-sm tabular-nums" :class="jobCount(c)?'text-green-600 font-semibold':'text-gray-400'"
                                      x-text="jobCount(c)?jobCount(c).toLocaleString():'-'"></span>
                            </td>
                            <td class="py-2.5 pr-3 text-right">
                                <span class="text-sm text-gray-500" x-text="lastScraped(c)"></span>
                            </td>
                            <td class="py-2.5 text-right">
                                <div class="inline-flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button @click="viewScraper(c)"
                                            class="inline-flex items-center gap-1 px-2.5 py-1 text-xs font-medium text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                        View
                                    </button>
                                    <button @click="startSingle(c)" :disabled="isRunning"
                                            class="inline-flex items-center gap-1 px-2.5 py-1 text-xs font-medium text-indigo-600 bg-indigo-50 rounded-md hover:bg-indigo-100 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/></svg>
                                        Run
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>

            <!-- Pagination -->
            <div x-show="filtered.length>perPage" class="flex items-center justify-between pt-4 mt-2 border-t border-gray-100">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500" x-text="((page-1)*perPage+1)+'-'+Math.min(page*perPage,filtered.length)+' of '+filtered.length"></span>
                    <select x-model.number="perPage" @change="page=1" class="text-xs border border-gray-300 rounded px-2 py-1 text-gray-600">
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="999">All</option>
                    </select>
                </div>
                <div class="flex items-center gap-1">
                    <button @click="page=1" :disabled="page===1" class="px-2 py-1 text-xs rounded border border-gray-200 text-gray-600 hover:bg-gray-50 disabled:opacity-40">First</button>
                    <button @click="page--" :disabled="page===1" class="px-2 py-1 text-xs rounded border border-gray-200 text-gray-600 hover:bg-gray-50 disabled:opacity-40">&laquo;</button>
                    <span class="px-3 py-1 text-xs font-medium text-gray-700" x-text="page+'/'+totalPages"></span>
                    <button @click="page++" :disabled="page>=totalPages" class="px-2 py-1 text-xs rounded border border-gray-200 text-gray-600 hover:bg-gray-50 disabled:opacity-40">&raquo;</button>
                    <button @click="page=totalPages" :disabled="page>=totalPages" class="px-2 py-1 text-xs rounded border border-gray-200 text-gray-600 hover:bg-gray-50 disabled:opacity-40">Last</button>
                </div>
            </div>

            <!-- Empty -->
            <div x-show="filtered.length===0&&!loading" class="text-center py-12">
                <p class="text-sm text-gray-500">No companies matching your search</p>
                <button @click="search=''" class="mt-2 text-sm text-indigo-600 hover:text-indigo-700 font-medium">Clear search</button>
            </div>
        </div>
    </div>

    <!-- Task History -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-5">
            <div>
                <h2 class="text-lg font-semibold text-gray-800">Task History</h2>
                <p class="text-sm text-gray-500 mt-0.5">Recent scraping runs</p>
            </div>
            <button @click="fetchTasks()" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                Refresh
            </button>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider border-b border-gray-100">
                        <th class="pb-3 pr-4">Target</th>
                        <th class="pb-3 pr-4">Status</th>
                        <th class="pb-3 pr-4 text-right">Progress</th>
                        <th class="pb-3 pr-4 text-right">Jobs</th>
                        <th class="pb-3 pr-4 text-right">Duration</th>
                        <th class="pb-3 text-right">Date</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50">
                    <template x-for="t in tasks" :key="t.task_id">
                        <tr class="hover:bg-gray-50 transition-colors text-sm cursor-pointer" @click="viewHistory(t)">
                            <td class="py-3 pr-4">
                                <span class="text-gray-800 font-medium" x-text="t.company_name||('All ('+t.total_companies+')')"></span>
                            </td>
                            <td class="py-3 pr-4">
                                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold"
                                      :class="{'bg-blue-100 text-blue-700':t.status==='running'||t.status==='pending','bg-green-100 text-green-700':t.status==='completed','bg-red-100 text-red-700':t.status==='failed','bg-yellow-100 text-yellow-700':t.status==='cancelled'}">
                                    <span class="w-1.5 h-1.5 rounded-full" :class="{'bg-blue-500':t.status==='running'||t.status==='pending','bg-green-500':t.status==='completed','bg-red-500':t.status==='failed','bg-yellow-500':t.status==='cancelled'}"></span>
                                    <span x-text="t.status.charAt(0).toUpperCase()+t.status.slice(1)"></span>
                                </span>
                            </td>
                            <td class="py-3 pr-4 text-right">
                                <span class="text-gray-600 tabular-nums" x-text="t.completed_companies+'/'+t.total_companies"></span>
                            </td>
                            <td class="py-3 pr-4 text-right">
                                <span class="font-semibold tabular-nums" :class="t.total_jobs_found?'text-green-600':'text-gray-400'"
                                      x-text="t.total_jobs_found.toLocaleString()"></span>
                            </td>
                            <td class="py-3 pr-4 text-right">
                                <span class="text-gray-500 tabular-nums" x-text="fmtDur(t)"></span>
                            </td>
                            <td class="py-3 text-right">
                                <span class="text-gray-500" x-text="fmtDate(t.started_at)"></span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <div x-show="tasks.length===0&&!loading" class="text-center py-12">
                <p class="text-sm text-gray-500">No tasks yet</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function scraperPanel() {
    return {
        companies: [], stats: {}, task: null, tasks: [],
        selected: [], search: '', workers: 10,
        sortBy: 'name', loading: true, poll: null,
        toasts: [], tid: 0,
        // Modal
        showModal: false, modalTask: null, modalEntries: [], mFilter: 'all',
        // Scraper Info Modal
        showInfoModal: false, scraperInfo: null, infoLoading: false,
        // Pagination
        page: 1, perPage: 50,

        sortLabels: {
            name:'Name (A-Z)', name_desc:'Name (Z-A)',
            jobs:'Jobs (High-Low)', jobs_asc:'Jobs (Low-High)',
            scraped:'Recent First', scraped_old:'Oldest First'
        },

        get isRunning() {
            return this.task && (this.task.status==='running'||this.task.status==='pending');
        },
        get filtered() {
            let list = [...this.companies];
            if (this.search.trim()) {
                const q = this.search.toLowerCase().trim();
                list = list.filter(c => c.toLowerCase().includes(q));
            }
            return this.doSort(list);
        },
        get totalPages() { return Math.ceil(this.filtered.length/this.perPage)||1; },
        get paginated() { return this.filtered.slice((this.page-1)*this.perPage, this.page*this.perPage); },
        get allSelected() { return this.filtered.length>0 && this.filtered.every(c=>this.selected.includes(c)); },
        get liveEntries() {
            if (!this.task?.results) return [];
            return Object.entries(this.task.results).map(([company, d]) => {
                if (typeof d==='object' && d) {
                    return d.error
                        ? {company, ok:false, error:d.error, jobs:0, dur:d.duration||0}
                        : {company, ok:true, jobs:d.jobs_count||d.jobs_found||d.jobs||0, dur:d.duration||0, error:''};
                }
                return {company, ok:true, jobs:d||0, dur:0, error:''};
            });
        },
        get filteredModalEntries() {
            if (this.mFilter==='ok') return this.modalEntries.filter(r=>r.ok);
            if (this.mFilter==='fail') return this.modalEntries.filter(r=>!r.ok);
            return this.modalEntries;
        },

        async init() {
            await Promise.all([this.fetchScrapers(), this.fetchStats(), this.fetchTasks()]);
            this.loading = false;
            const running = this.tasks.find(t=>t.status==='running'||t.status==='pending');
            if (running) { this.task = running; this.startPoll(); }
        },

        async fetchScrapers() {
            try { const r=await fetch('/api/scraper/scrapers/'); const d=await r.json(); this.companies=d.companies||[]; } catch(e) { this.toast('Failed to load scrapers','error'); }
        },
        async fetchStats() {
            try {
                const r=await fetch('/api/companies/'); const d=await r.json();
                this.stats={};
                if (Array.isArray(d)) d.forEach(i => { this.stats[i.company_name]={count:i.count,last:i.last_scraped}; });
            } catch(e) {}
        },
        async fetchTasks() {
            try { const r=await fetch('/api/scraper/tasks/'); const d=await r.json(); this.tasks=Array.isArray(d)?d:[]; } catch(e) {}
        },

        async pollTask() {
            if (!this.task) return;
            try {
                const r=await fetch('/api/scraper/tasks/'+this.task.task_id+'/');
                const d=await r.json();
                this.task=d;
                this.$nextTick(()=>{ const s=this.$refs.stream; if(s) s.scrollTop=s.scrollHeight; });
                if (d.status!=='running'&&d.status!=='pending') {
                    this.stopPoll(); this.fetchTasks(); this.fetchStats();
                    if (d.status==='completed') this.toast('Scraping completed! '+d.total_jobs_found.toLocaleString()+' jobs found.','success');
                    else if (d.status==='failed') this.toast('Task failed: '+(d.error_message||'Unknown error'),'error');
                    else if (d.status==='cancelled') this.toast('Task cancelled.','warning');
                }
            } catch(e) {}
        },
        startPoll() { this.stopPoll(); this.poll=setInterval(()=>this.pollTask(),2000); },
        stopPoll() { if(this.poll){clearInterval(this.poll);this.poll=null;} },

        // Modal
        openModal(t) {
            this.modalTask=t; this.mFilter='all';
            const entries = Object.entries(t.results||{}).map(([company,d])=>{
                if(typeof d==='object'&&d) return d.error ? {company,ok:false,error:d.error,jobs:0,dur:d.duration||0} : {company,ok:true,jobs:d.jobs_count||d.jobs_found||d.jobs||0,dur:d.duration||0,error:''};
                return {company,ok:true,jobs:d||0,dur:0,error:''};
            });
            entries.sort((a,b)=>{ if(a.ok!==b.ok) return b.ok-a.ok; return (b.jobs||0)-(a.jobs||0); });
            this.modalEntries=entries; this.showModal=true;
        },
        viewHistory(t) { if(t.results&&Object.keys(t.results).length) this.openModal(t); },

        async viewScraper(company) {
            this.scraperInfo = null; this.infoLoading = true; this.showInfoModal = true;
            try {
                const r = await fetch('/api/scraper/scrapers/'+encodeURIComponent(company)+'/info/');
                if (r.ok) this.scraperInfo = await r.json();
                else this.scraperInfo = {company, url:'', scraper_class:'Unknown', error:'Failed to load'};
            } catch(e) { this.scraperInfo = {company, url:'', scraper_class:'Unknown', error:e.message}; }
            this.infoLoading = false;
        },

        // Actions
        async startAll() {
            if(this.isRunning) return;
            try {
                const r=await fetch('/api/scraper/start/',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({all:true,max_workers:this.workers})});
                if(!r.ok){const e=await r.json();throw new Error(e.error||'Failed');}
                this.task=await r.json(); this.startPoll(); this.toast('Started scraping all companies','success'); this.fetchTasks();
            } catch(e) { this.toast(e.message||'Failed to start','error'); }
        },
        async startSelected() {
            if(!this.selected.length||this.isRunning) return;
            try {
                const r=await fetch('/api/scraper/start/',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({companies:this.selected,max_workers:this.workers})});
                if(!r.ok){const e=await r.json();throw new Error(e.error||'Failed');}
                this.task=await r.json(); this.startPoll(); this.toast('Started scraping '+this.selected.length+' companies','success'); this.fetchTasks();
            } catch(e) { this.toast(e.message||'Failed to start','error'); }
        },
        async startSingle(company) {
            if(this.isRunning) return;
            try {
                const r=await fetch('/api/scraper/start/'+encodeURIComponent(company)+'/',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({})});
                if(!r.ok){const e=await r.json();throw new Error(e.error||'Failed');}
                this.task=await r.json(); this.startPoll(); this.toast('Started scraping '+company,'info'); this.fetchTasks();
            } catch(e) { this.toast(e.message||'Failed to start','error'); }
        },
        async cancelTask(id) {
            try {
                const r=await fetch('/api/scraper/tasks/'+id+'/cancel/',{method:'POST',headers:{'Content-Type':'application/json'}});
                if(!r.ok){const e=await r.json();throw new Error(e.error||'Failed');}
                this.task=await r.json(); this.stopPoll(); this.toast('Task cancelled','warning'); this.fetchTasks();
            } catch(e) { this.toast(e.message||'Failed to cancel','error'); }
        },

        // Company helpers
        toggleOne(c) { const i=this.selected.indexOf(c); i>-1?this.selected.splice(i,1):this.selected.push(c); },
        toggleAll() {
            if(this.allSelected) this.selected=this.selected.filter(c=>!this.filtered.includes(c));
            else this.selected=[...this.selected,...this.filtered.filter(c=>!this.selected.includes(c))];
        },
        jobCount(c) { return this.stats[c]?.count||0; },
        lastScraped(c) { return this.stats[c]?.last ? this.ago(this.stats[c].last) : 'Never'; },

        doSort(list) {
            const s=this.stats;
            switch(this.sortBy) {
                case 'name': return list.sort((a,b)=>a.localeCompare(b));
                case 'name_desc': return list.sort((a,b)=>b.localeCompare(a));
                case 'jobs': return list.sort((a,b)=>((s[b]?.count||0)-(s[a]?.count||0))||a.localeCompare(b));
                case 'jobs_asc': return list.sort((a,b)=>((s[a]?.count||0)-(s[b]?.count||0))||a.localeCompare(b));
                case 'scraped': return list.sort((a,b)=>(new Date(s[b]?.last||0))-(new Date(s[a]?.last||0))||a.localeCompare(b));
                case 'scraped_old': return list.sort((a,b)=>(new Date(s[a]?.last||0))-(new Date(s[b]?.last||0))||a.localeCompare(b));
                default: return list;
            }
        },

        // Formatting
        ago(d) {
            if(!d) return 'Never';
            const s=Math.floor((Date.now()-new Date(d))/1000);
            if(s<60) return 'Just now';
            const m=Math.floor(s/60); if(m<60) return m+'m ago';
            const h=Math.floor(m/60); if(h<24) return h+'h ago';
            const dy=Math.floor(h/24); if(dy<30) return dy+'d ago';
            return Math.floor(dy/30)+'mo ago';
        },
        fmtDur(t) {
            if(!t.started_at) return '--';
            const start=new Date(t.started_at), end=t.finished_at?new Date(t.finished_at):new Date();
            const s=Math.max(0,Math.floor((end-start)/1000));
            const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60;
            if(h) return h+'h '+m+'m '+sec+'s';
            if(m) return m+'m '+sec+'s';
            return sec+'s';
        },
        fmtDate(d) {
            if(!d) return '-';
            return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
        },

        toast(msg,type='info') {
            const id=++this.tid, t={id,msg,type,show:true};
            this.toasts.push(t);
            setTimeout(()=>{t.show=false;setTimeout(()=>{this.toasts=this.toasts.filter(x=>x.id!==id);},300);},4000);
        }
    };
}
</script>
{% endblock %}
